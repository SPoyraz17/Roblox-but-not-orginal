<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROBLOX Hibrit Platform - 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script> 
    
    <style>
        /* --- CSS STÄ°LLERÄ° --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .screen {
            width: 100%;
            max-width: 1200px; /* Daha geniÅŸ alan */
            margin: 20px auto;
            display: none;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 20px;
        }

        /* Studio & Game Canvas (Åimdi Three.js Renderer'Ä±) */
        .canvas-container {
            display: flex;
            position: relative;
        }

        #studioCanvasContainer, #gameCanvasContainer {
            width: 900px;
            height: 600px;
            border: 3px solid #333;
            /* Three.js buraya render eder */
        }
        
        #studioToolbar {
            padding: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-left: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 250px;
        }

        button {
            padding: 10px 15px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #005f99; }
        
        /* Ä°mleci Studio'da ayarlÄ±yoruz */
        .studio-active {
             cursor: default; /* Blok seÃ§ili deÄŸilken normal imleÃ§ */
        }
    </style>
</head>
<body>

    <div id="homeScreen" class="screen" style="display: block;"> 
        <h1>Roblox Hibrit Platform - Ana Ekran (3D)</h1>
        <p>Projeleriniz:</p>
        <div style="display: flex; flex-wrap: wrap;">
            <div class="game-tile" onclick="loadAndShowStudio();">
                <h2>ğŸ–Œï¸ 3D Studio (Harita OluÅŸtur)</h2>
                <p>WASD ile hareket edin, fare ile Ã§evirin. BloklarÄ± sÃ¼rÃ¼kleyerek taÅŸÄ±yÄ±n.</p>
            </div>
            <div class="game-tile" onclick="loadAndStartGame();">
                <h2>â–¶ï¸ Parkur DÃ¼nyasÄ± (Oyna - 3D)</h2>
                <p>Kaydedilen haritada karakterinizi hareket ettirin.</p>
            </div>
        </div>
    </div>

    <div id="studioScreen" class="screen">
        <h1 style="color: #00a000;">Roblox 3D Studio</h1>
        <button onclick="stopStudioLoop(); showScreen('homeScreen');" style="margin-bottom: 10px;">ğŸ  Ana Ekrana DÃ¶n</button>
        
        <div class="canvas-container">
            <div id="studioCanvasContainer">
                </div>
            <div id="studioToolbar">
                <button onclick="addBlock(0, 5, 0);">Yeni Platform Ekle</button>
                <button onclick="saveMapToLocal();" style="background-color: #ffaa00;">ğŸ’¾ HaritayÄ± Kaydet (JSON)</button>
                <button onclick="loadMapFromLocal();">ğŸ”„ KayÄ±tlÄ± HaritayÄ± YÃ¼kle</button>
                <button onclick="clearMap();" style="background-color: #cc0000;">HaritayÄ± Temizle</button>
                <p>Kontroller:</p>
                <ul>
                    <li>**WASD:** Ä°leri/Geri/Yanlara hareket</li>
                    <li>**Mouse Sol TÄ±k + SÃ¼rÃ¼kle:** KamerayÄ± dÃ¶ndÃ¼r</li>
                    <li>**Blok TÄ±kla + SÃ¼rÃ¼kle:** BloklarÄ± taÅŸÄ±</li>
                </ul>
                <p id="selectedBlockInfo">SeÃ§ili Blok: Yok</p>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <h1 style="color: #0000ff;">3D Parkur Oyunu</h1>
        <button onclick="stopGameLoop(); showScreen('homeScreen');" style="margin-bottom: 10px;">ğŸ  Ana Ekrana DÃ¶n</button>
        <div id="gameCanvasContainer">
            </div>
    </div>

    <script>
        // --- TEMEL GLOBAL AYARLAR ---
        const GAME_MAP_KEY = "RobloxMapData3D"; 
        const CANVAS_W = 900;
        const CANVAS_H = 600;
        
        // 3D Harita Verisi: { x, y, z, w, h, d }
        let currentPlatforms = []; 
        let studioScene, studioCamera, studioRenderer;
        let studioAnimationFrame = null;

        // Kamera Kontrolleri
        let keys = {};
        let mouseLook = false;
        let selectedMesh = null; // Raycasting ile seÃ§ilen blok
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // --- EKRAN YÃ–NETÄ°MÄ° ---
        const screens = ['homeScreen', 'studioScreen', 'gameScreen'];
        
        function showScreen(screenId) {
            screens.forEach(id => {
                document.getElementById(id).style.display = 'none';
                document.body.classList.remove('studio-active');
            });
            document.getElementById(screenId).style.display = 'block';
            
            if (screenId === 'studioScreen') {
                document.body.classList.add('studio-active');
                if (!studioScene) setupStudio3D();
                startStudioLoop();
            } else {
                stopStudioLoop();
                // Oyun baÅŸlatÄ±lacaksa buraya 3D oyun kurulumu gelir
                if (screenId === 'gameScreen') {
                     setupGame3D();
                     startGameLoop();
                } else {
                    stopGameLoop();
                }
            }
        }
        
        function loadAndShowStudio() {
             loadMapFromLocal();
             showScreen('studioScreen');
        }

        // --- 1. JSON / KAYIT Ä°ÅLEMLERÄ° (3D Veri KaydÄ±) ---

        function saveMapToLocal() {
            try {
                // Harita verisini (currentPlatforms dizisi) JSON dizesine Ã§evir
                const jsonString = JSON.stringify(currentPlatforms.map(p => ({
                    x: p.position.x, y: p.position.y, z: p.position.z,
                    w: p.scale.x, h: p.scale.y, d: p.scale.z
                })));
                localStorage.setItem(GAME_MAP_KEY, jsonString);
                alert("Harita baÅŸarÄ±yla yerel olarak kaydedildi (JSON)!");
            } catch (e) {
                alert("Hata: Harita kaydedilemedi!");
                console.error(e);
            }
        }

        function loadMapFromLocal() {
            try {
                // Ã–nce Three.js sahnede olan tÃ¼m bloklarÄ± temizle
                if (studioScene) clearScene(studioScene); 
                currentPlatforms = [];
                
                const jsonString = localStorage.getItem(GAME_MAP_KEY);
                let loadedData;

                if (jsonString) {
                    loadedData = JSON.parse(jsonString);
                    alert(`Harita baÅŸarÄ±yla yÃ¼klendi! (${loadedData.length} platform)`);
                } else {
                    // VarsayÄ±lan zemin
                    loadedData = [{ x: 0, y: -0.5, z: 0, w: 50, h: 1, d: 50 }]; 
                    alert("KayÄ±tlÄ± harita bulunamadÄ±, varsayÄ±lan zemin yÃ¼klendi.");
                }

                loadedData.forEach(data => {
                    // YÃ¼klenen veriyi kullanarak 3D bloklarÄ± oluÅŸtur
                    addBlock(data.x, data.y, data.z, data.w, data.h, data.d);
                });
                return true;
            } catch (e) {
                alert("Hata: KayÄ±tlÄ± harita bozuk!");
                return false;
            }
        }

        function clearMap() {
            clearScene(studioScene);
            currentPlatforms = [];
            addBlock(0, -0.5, 0, 50, 1, 50); // VarsayÄ±lan zemin
            saveMapToLocal();
        }

        function clearScene(scene) {
            if (!scene) return;
            while(scene.children.length > 0){ 
                const child = scene.children[0];
                if (child.isMesh) {
                    child.geometry.dispose();
                    child.material.dispose();
                }
                scene.remove(child);
            }
        }

        // --- 2. 3D STUDIO MANTIÄI (THREE.JS) ---

        function setupStudio3D() {
            // 1. Sahneyi OluÅŸtur
            studioScene = new THREE.Scene();
            studioScene.background = new THREE.Color(0x87ceeb); // Mavi GÃ¶kyÃ¼zÃ¼

            // 2. KamerayÄ± OluÅŸtur
            studioCamera = new THREE.PerspectiveCamera(75, CANVAS_W / CANVAS_H, 0.1, 1000);
            studioCamera.position.set(20, 10, 20);
            studioCamera.lookAt(0, 0, 0);

            // 3. Renderer'Ä± OluÅŸtur ve DOM'a Ekle
            studioRenderer = new THREE.WebGLRenderer({ antialias: true });
            studioRenderer.setSize(CANVAS_W, CANVAS_H);
            
            const container = document.getElementById('studioCanvasContainer');
            // Ã–nceki varsa sil
            while (container.firstChild) { container.removeChild(container.firstChild); }
            container.appendChild(studioRenderer.domElement);

            // 4. IÅŸÄ±klarÄ± Ekle
            studioScene.add(new THREE.AmbientLight(0x404040));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
            directionalLight.position.set(10, 10, 5);
            studioScene.add(directionalLight);
            
            // 5. Kontrolleri Ekle
            setupStudioControls(studioRenderer.domElement);
        }

        function addBlock(x, y, z, w = 4, h = 4, d = 4, color = 0x228B22) {
            const geometry = new THREE.BoxGeometry(w, h, d);
            const material = new THREE.MeshLambertMaterial({ color: color });
            const block = new THREE.Mesh(geometry, material);
            
            block.position.set(x, y, z);
            block.scale.set(w, h, d); // Scale'i de veriye uygun ayarla

            block.userData = { isBlock: true, id: Date.now() }; // Blok olduÄŸunu iÅŸaretle
            studioScene.add(block);
            currentPlatforms.push(block);
        }

        // --- 3. KAMERA VE HAREKET KONTROLLERÄ° ---

        let rotationX = 0;
        let rotationY = 0;
        const moveSpeed = 0.5;
        const rotateSpeed = 0.005;

        function setupStudioControls(domElement) {
            window.addEventListener('keydown', (e) => { keys[e.key.toLowerCase()] = true; });
            window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
            
            // Mouse ile dÃ¶ndÃ¼rme (Kamera Look)
            domElement.addEventListener('mousedown', onMouseDown);
            domElement.addEventListener('mousemove', onMouseMove);
            domElement.addEventListener('mouseup', onMouseUp);
        }

        function onMouseDown(e) {
            if (e.button === 0) { // Sol tÄ±k
                mouse.x = (e.offsetX / CANVAS_W) * 2 - 1;
                mouse.y = -(e.offsetY / CANVAS_H) * 2 + 1;
                
                raycaster.setFromCamera(mouse, studioCamera);
                const intersects = raycaster.intersectObjects(studioScene.children.filter(c => c.userData.isBlock));

                if (intersects.length > 0) {
                    selectedMesh = intersects[0].object;
                    selectedMesh.material.color.set(0xffa500); // Turuncu yap
                    document.getElementById('selectedBlockInfo').textContent = `SeÃ§ili Blok: ${selectedMesh.userData.id}`;
                    mouseLook = false; // Blok seÃ§ildi, kamera dÃ¶nmeyecek
                    // Raycast kesiÅŸim noktasÄ±nÄ± kaydet (Zemin dÃ¼zlemi iÃ§in)
                    selectedMesh.userData.dragStartPoint = intersects[0].point;
                } else {
                    // Blok seÃ§ilmedi, kamera dÃ¶nmeye baÅŸlayacak
                    selectedMesh = null;
                    document.getElementById('selectedBlockInfo').textContent = `SeÃ§ili Blok: Yok`;
                    mouseLook = true;
                    // BaÅŸlangÄ±Ã§ fare pozisyonunu kaydet
                    rotationX = e.clientX;
                    rotationY = e.clientY;
                }
            }
        }

        function onMouseMove(e) {
            if (mouseLook) {
                // KamerayÄ± DÃ¶ndÃ¼r (Ã‡evreleme)
                const deltaX = e.clientX - rotationX;
                const deltaY = e.clientY - rotationY;
                
                studioCamera.rotation.y -= deltaX * rotateSpeed;
                studioCamera.rotation.x -= deltaY * rotateSpeed;
                
                // Rotation Y (yukarÄ±/aÅŸaÄŸÄ±) sÄ±nÄ±rla
                studioCamera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, studioCamera.rotation.x));

                rotationX = e.clientX;
                rotationY = e.clientY;
            } else if (selectedMesh) {
                // Blok SÃ¼rÃ¼kleme (Raycasting ile)
                // Basit bir zemin dÃ¼zleminde taÅŸÄ±ma uyguluyoruz.
                mouse.x = (e.offsetX / CANVAS_W) * 2 - 1;
                mouse.y = -(e.offsetY / CANVAS_H) * 2 + 1;
                
                raycaster.setFromCamera(mouse, studioCamera);
                
                // Zemin dÃ¼zlemini oluÅŸtur (y=0)
                const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
                const intersectPoint = new THREE.Vector3();
                raycaster.ray.intersectPlane(plane, intersectPoint);

                if (intersectPoint) {
                    selectedMesh.position.x = intersectPoint.x;
                    selectedMesh.position.z = intersectPoint.z;
                }
            }
        }

        function onMouseUp() {
            mouseLook = false;
            if (selectedMesh) {
                selectedMesh.material.color.set(0x228B22); // Normal renge dÃ¶n
                selectedMesh = null;
            }
        }

        function updateCamera() {
            const direction = new THREE.Vector3();
            studioCamera.getWorldDirection(direction);

            let moveVector = new THREE.Vector3(0, 0, 0);

            if (keys['w']) moveVector.z -= 1;
            if (keys['s']) moveVector.z += 1;
            if (keys['a']) moveVector.x -= 1;
            if (keys['d']) moveVector.x += 1;

            if (moveVector.lengthSq() > 0) {
                moveVector.normalize().multiplyScalar(moveSpeed);
                
                // Ä°leri/Geri (KameranÄ±n baktÄ±ÄŸÄ± yÃ¶n)
                const forward = direction.clone();
                forward.y = 0; // YÃ¼ksekliÄŸi sÄ±fÄ±rla
                forward.normalize();
                studioCamera.position.addScaledVector(forward, -moveVector.z);

                // Yanlara (SaÄŸ/Sol vektÃ¶r)
                const right = new THREE.Vector3().crossVectors(studioCamera.up, forward).normalize();
                studioCamera.position.addScaledVector(right, moveVector.x);
            }
        }

        // --- 4. 3D DÃ–NGÃœSÃœ ---

        function animateStudio() {
            updateCamera();
            studioRenderer.render(studioScene, studioCamera);
            studioAnimationFrame = requestAnimationFrame(animateStudio);
        }

        function startStudioLoop() {
             if (studioAnimationFrame) cancelAnimationFrame(studioAnimationFrame);
             animateStudio();
        }

        function stopStudioLoop() {
            if (studioAnimationFrame) cancelAnimationFrame(studioAnimationFrame);
            studioAnimationFrame = null;
        }

        // --- OYUN CLIENT MANTIÄI (Basit yer tutucu) ---
        let gameAnimationFrame = null;
        let gameScene, gameCamera, gameRenderer;
        
        function setupGame3D() {
            // Basit Oyun OrtamÄ± Kurulumu (Studio'dan farklÄ± bir kamera vb.)
            gameScene = new THREE.Scene();
            gameScene.background = new THREE.Color(0x87ceeb);

            gameCamera = new THREE.PerspectiveCamera(75, CANVAS_W / CANVAS_H, 0.1, 1000);
            gameCamera.position.set(0, 5, 10);
            gameCamera.lookAt(0, 0, 0);
            
            gameScene.add(new THREE.AmbientLight(0x404040));
            gameScene.add(new THREE.DirectionalLight(0xffffff, 0.8));

            gameRenderer = new THREE.WebGLRenderer({ antialias: true });
            gameRenderer.setSize(CANVAS_W, CANVAS_H);

            const container = document.getElementById('gameCanvasContainer');
            while (container.firstChild) { container.removeChild(container.firstChild); }
            container.appendChild(gameRenderer.domElement);
            
            // Kaydedilen bloklarÄ± Oyuncu ortamÄ±na ekle
            currentPlatforms.forEach(mesh => {
                // Oyuncu iÃ§in mesh'in kopyasÄ±nÄ± oluÅŸtur (malzeme ve geometriyi tekrar kullan)
                const block = new THREE.Mesh(mesh.geometry, mesh.material.clone()); 
                block.position.copy(mesh.position);
                block.scale.copy(mesh.scale);
                gameScene.add(block);
            });
            
            // Oyuncu temsilcisi
            const playerGeo = new THREE.BoxGeometry(1, 2, 1);
            const playerMat = new THREE.MeshLambertMaterial({ color: 0xff0000 });
            const playerMesh = new THREE.Mesh(playerGeo, playerMat);
            playerMesh.position.set(0, 1, 0);
            gameScene.add(playerMesh);
            
            // Bu kÄ±sma 3D fizik ve oyuncu kontrol mantÄ±ÄŸÄ± entegre edilecektir.
        }

        function updateGame() {
            // 3D Fizik ve Girdi GÃ¼ncellemeleri buraya gelecek.
        }

        function drawGame() {
            gameRenderer.render(gameScene, gameCamera);
        }

        function gameLoop() {
            updateGame();
            drawGame();
            gameAnimationFrame = requestAnimationFrame(gameLoop);
        }
        
        function startGameLoop() {
             if (gameAnimationFrame) cancelAnimationFrame(gameAnimationFrame);
             gameLoop();
        }

        function stopGameLoop() {
            if (gameAnimationFrame) cancelAnimationFrame(gameAnimationFrame);
            gameAnimationFrame = null;
        }
        
        // --- UYGULAMA BAÅLANGICI ---
        window.onload = () => {
            showScreen('homeScreen'); 
        };
    </script>
</body>
</html>
