<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROBLOX Hibrit Platform - 3D</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script> 
    
    <style>
        /* --- CSS STÄ°LLERÄ° --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            user-select: none; 
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        .screen {
            width: 100%;
            max-width: 1200px; 
            margin: 20px auto;
            display: none;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 20px;
        }

        /* Ana Ekran */
        .game-tile {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            text-align: center;
            border-radius: 5px;
            transition: background-color 0.3s;
            width: 300px;
        }
        .game-tile:hover { background-color: #e0f7ff; }

        /* Studio & Game Canvas Container */
        .canvas-container {
            display: flex;
            position: relative;
            align-items: flex-start; /* Telefonu yukarÄ± hizala */
        }

        #studioCanvasContainer, #gameCanvasContainer {
            width: 900px;
            height: 600px;
            border: 3px solid #333;
        }
        
        #studioToolbar {
            padding: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-left: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 250px;
            height: 600px;
        }

        /* Oturum AÃ§ma EkranÄ± */
        #loginScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            border: 1px solid #ccc;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #loginScreen input {
            padding: 10px;
            margin: 10px 0;
            width: 250px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 10px 15px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #005f99; }
        
        #studioCanvasContainer {
             cursor: default;
        }

        #selectedBlockInfo {
            font-weight: bold;
            color: #333;
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }

        /* --- TELEFON ARAYÃœZÃœ (AI MESAJLAÅMA) --- */
        #phonePanel {
            width: 300px;
            height: 600px;
            margin-left: 20px;
            background: #222;
            border-radius: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #chatHeader {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        #chatWindow {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            max-width: 80%;
            padding: 8px;
            border-radius: 15px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: #e6e6e6;
            border-bottom-left-radius: 0;
        }

        .user-message {
            align-self: flex-end;
            background-color: #007acc;
            color: white;
            border-bottom-right-radius: 0;
        }

        #chatInput {
            display: flex;
            border-top: 1px solid #ccc;
        }

        #messageInput {
            flex-grow: 1;
            padding: 10px;
            border: none;
            outline: none;
        }

        #sendButton {
            width: 60px;
            background-color: #4CAF50;
            border-radius: 0;
        }

        #aiSelector {
            padding: 5px;
            margin-bottom: 5px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <script>
        document.addEventListener('contextmenu', (e) => {
            const gameContainer = document.getElementById('gameCanvasContainer');
            if (gameContainer && gameContainer.contains(e.target)) {
                e.preventDefault();
            }
        });
    </script>

    <div id="loginScreenContainer" class="screen" style="display: flex;"> 
        <h1>HoÅŸ Geldiniz</h1>
        <div id="loginScreen">
            <h2>Oturum AÃ§</h2>
            <input type="text" id="usernameInput" placeholder="KullanÄ±cÄ± AdÄ±" value="User123">
            <button onclick="loginUser();">GiriÅŸ Yap</button>
        </div>
    </div>

    <div id="homeScreen" class="screen"> 
        <h1 id="welcomeMessage"></h1>
        <p>Projelerinizi seÃ§in:</p>
        <div style="display: flex; flex-wrap: wrap;">
            <div class="game-tile" onclick="loadAndShowStudio();">
                <h2>ğŸ–Œï¸ 3D Studio (Harita OluÅŸtur)</h2>
                <p>**N**, **B**, **O** modlarÄ±, **fare tekerleÄŸi** ile zoom ve **mobil arayÃ¼z** aktif.</p>
            </div>
            <div class="game-tile" onclick="loadAndStartGame();">
                <h2>â–¶ï¸ Parkur DÃ¼nyasÄ± (Oyna - TPS)</h2>
                <p>**WASD, Space**, **SaÄŸ TÄ±k** ile Ã§evirme ve **fare tekerleÄŸi** ile zoom aktif.</p>
            </div>
        </div>
    </div>

    <div id="studioScreen" class="screen">
        <h1 style="color: #00a000;">Roblox 3D Studio</h1>
        <button onclick="stopStudioLoop(); showScreen('homeScreen');" style="margin-bottom: 10px;">ğŸ  Ana Ekrana DÃ¶n</button>
        
        <div class="canvas-container">
            <div style="display: flex; flex-direction: column;">
                <div id="studioCanvasContainer">
                    </div>
                <div id="studioToolbar">
                    <button onclick="addBlock(0, 5, 0);">Yeni Platform Ekle</button>
                    <button onclick="saveMapToLocal();" style="background-color: #ffaa00;">ğŸ’¾ HaritayÄ± Kaydet (JSON)</button>
                    <button onclick="loadMapFromLocalAndRefresh();">ğŸ”„ KayÄ±tlÄ± HaritayÄ± YÃ¼kle</button>
                    <button onclick="clearMap();" style="background-color: #cc0000;">HaritayÄ± Temizle</button>
                    
                    <p id="selectedBlockInfo">Mod: TaÅŸÄ±ma (N). Blok: Yok</p>

                    <div style="border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px;">
                        <p>Kontroller:</p>
                        <ul>
                            <li>**N/B/O:** Mod DeÄŸiÅŸtir</li>
                            <li>**Fare TekerleÄŸi:** YakÄ±nlaÅŸtÄ±r/UzaklaÅŸtÄ±r</li>
                            <li>**SaÄŸ TÄ±k SÃ¼rÃ¼kle:** Kamera DÃ¶ndÃ¼r</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="phonePanel">
                <div id="chatHeader">ğŸ“± MesajlaÅŸma</div>
                <select id="aiSelector" onchange="loadChatHistory(this.value);">
                    <option value="PatatesSamocan">ğŸ¤– PatatesSamocan</option>
                    <option value="KediKIZ">ğŸ± KediKIZ</option>
                </select>
                <div id="chatWindow">
                    </div>
                <div id="chatInput">
                    <input type="text" id="messageInput" placeholder="Mesaj yazÄ±n..." onkeydown="if(event.key === 'Enter') sendMessage();">
                    <button id="sendButton" onclick="sendMessage();">GÃ¶nder</button>
                </div>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <h1 style="color: #0000ff;">3D Parkur Oyunu (TPS)</h1>
        <button onclick="stopGameLoop(); showScreen('homeScreen');" style="margin-bottom: 10px;">ğŸ  Ana Ekrana DÃ¶n</button>
        <div id="gameCanvasContainer">
            </div>
        <p style="margin-top: 10px;">Karakteri dÃ¶ndÃ¼rmek iÃ§in **SaÄŸ Fare TuÅŸuna basÄ±lÄ± tutarak** fareyi hareket ettirin. **Fare TekerleÄŸi** ile zoom yapÄ±n.</p>
    </div>

    <script>
        // --- TEMEL GLOBAL AYARLAR ---
        const GAME_MAP_KEY = "RobloxMapData3D"; 
        const CANVAS_W = 900;
        const CANVAS_H = 600;
        const HANDLE_SIZE = 0.5; 
        const ARROW_LENGTH = 8; 
        
        // 3D Three.js Sahne DeÄŸiÅŸkenleri
        let mapDataJSON = []; 
        let studioScene, studioCamera, studioRenderer;
        let studioAnimationFrame = null;
        
        // Studio Kontrol DeÄŸiÅŸkenleri
        let keys = {};
        let mouseLook = false; 
        let studioMode = 'n'; 
        let selectedMesh = null; 
        let selectedHandle = null; 
        let transformControlsGroup = null; 

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // OYUN Ä°STEMCÄ°SÄ° DEÄÄ°ÅKENLERÄ°
        let gameScene, gameCamera, gameRenderer;
        let gameAnimationFrame = null;
        let playerMesh = null;
        let isGameDragging = false;
        let gameDragStart = { x: 0, y: 0 };
        let currentZoomLevel = 1.0; // Studio/Game iÃ§in zoom seviyesi
        
        // TPS Kamera AyarlarÄ±
        let TPS_DISTANCE_DEFAULT = 12; // VarsayÄ±lan
        let TPS_HEIGHT = 6;            
        const GAME_ROTATE_SPEED = 0.005; 
        const MAX_ZOOM = 4;
        const MIN_ZOOM = 0.5;
        
        // Oyuncu Fizik Parametreleri (KÄ±saltÄ±ldÄ±)
        const PLAYER_HEIGHT = 2;
        const PLAYER_RADIUS = 0.5;
        const GRAVITY = 0.08;
        const JUMP_FORCE = 1.0;
        const MOVE_SPEED = 0.1;
        
        // OTURUM ve AI DEÄÄ°ÅKENLERÄ°
        let currentUserName = "Misafir";
        let chatHistory = {
            "PatatesSamocan": [],
            "KediKIZ": []
        };
        

        // --- 0. OTURUM AÃ‡MA MANTIÄI ---
        
        function loginUser() {
            const username = document.getElementById('usernameInput').value.trim();
            if (username.length > 0) {
                currentUserName = username;
                document.getElementById('welcomeMessage').textContent = `HoÅŸ Geldin, ${currentUserName}!`;
                showScreen('homeScreen');
            } else {
                alert("LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin.");
            }
        }

        // --- 1. EKRAN VE MOD YÃ–NETÄ°MÄ° (KÄ±saltÄ±ldÄ±) ---
        
        function getModeText() {
            switch(studioMode) {
                case 'n': return 'TaÅŸÄ±ma (N)';
                case 'b': return 'BoyutlandÄ±rma (B)';
                case 'o': return 'DÃ¶ndÃ¼rme (O)';
                default: return 'Bilinmiyor';
            }
        }

        function updateToolbarInfo() {
             const blockInfo = selectedMesh ? `Blok ID: ${selectedMesh.userData.id}` : 'Blok: Yok';
             document.getElementById('selectedBlockInfo').textContent = `Mod: ${getModeText()}. ${blockInfo}`;
        }
        
        function showScreen(screenId) {
            const screens = ['loginScreenContainer', 'homeScreen', 'studioScreen', 'gameScreen'];
            screens.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(screenId).style.display = 'block';
            
            if (screenId === 'studioScreen') {
                document.getElementById('studioScreen').style.display = 'flex'; // Flex container ayarÄ±
                updateToolbarInfo();
                startStudioLoop();
                loadChatHistory(document.getElementById('aiSelector').value); // Sohbeti yÃ¼kle
            } else {
                stopStudioLoop();
                if(transformControlsGroup) transformControlsGroup.visible = false;
                selectedMesh = null;
                selectedHandle = null;
            }
            
            if (screenId === 'gameScreen') {
                 document.getElementById('gameScreen').style.display = 'block';
                startGameLoop();
            } else {
                stopGameLoop();
            }
        }
        
        function loadAndShowStudio() {
            loadMapFromLocal(); 
            setupStudio3D();    
            createBlocksFromData(studioScene, mapDataJSON, true); 
            showScreen('studioScreen');
        }
        
        // ... (JSON, Harita Ekleme/Temizleme fonksiyonlarÄ± aynen kalÄ±r) ... 
        
        // --- 2. 3D STUDIO KURULUMU VE MANTIÄI (KÄ±saltÄ±ldÄ±) ---

        function setupStudio3D() {
            if (studioScene) return; 
            
            studioScene = new THREE.Scene(); 
            studioScene.background = new THREE.Color(0x87ceeb); 

            studioCamera = new THREE.PerspectiveCamera(75, CANVAS_W / CANVAS_H, 0.1, 1000);
            studioCamera.position.set(20, 10, 20);
            studioCamera.lookAt(0, 0, 0);

            studioRenderer = new THREE.WebGLRenderer({ antialias: true });
            studioRenderer.setSize(CANVAS_W, CANVAS_H);
            
            const container = document.getElementById('studioCanvasContainer');
            while (container.firstChild) { container.removeChild(container.firstChild); }
            container.appendChild(studioRenderer.domElement);

            studioScene.add(new THREE.AmbientLight(0x404040)); 
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
            directionalLight.position.set(10, 10, 5);
            studioScene.add(directionalLight);
            
            transformControlsGroup = new THREE.Group();
            transformControlsGroup.visible = false;
            studioScene.add(transformControlsGroup);

            setupStudioControls(studioRenderer.domElement);
        }
        
        // ... (addBlock, createBlocksFromData fonksiyonlarÄ± aynen kalÄ±r) ... 

        // --- HANDLE YARDIMCI FONKSÄ°YONLARI (Aynen KalÄ±r) ---
        // ... (createArrow, createResizeSphere, createRotationTorus, attachHandles aynen kalÄ±r) ...
        
        // --- 3. STUDIO KONTROLLERÄ° VE MANÄ°PÃœLASYON ---

        let rotationX = 0;
        let rotationY = 0;
        const moveSpeed = 0.5;
        const rotateSpeed = 0.005;

        function setupStudioControls(domElement) {
            window.addEventListener('keydown', (e) => { 
                const key = e.key.toLowerCase();
                keys[key] = true; 
                
                // Mod deÄŸiÅŸimleri
                if (key === 'n' || key === 'b' || key === 'o') {
                    studioMode = key;
                    updateToolbarInfo();
                    if (selectedMesh) {
                        attachHandles(selectedMesh);
                    } else {
                        attachHandles(null);
                    }
                }
            });
            window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
            
            domElement.addEventListener('mousedown', onMouseDown);
            domElement.addEventListener('mousemove', onMouseMove);
            domElement.addEventListener('mouseup', onMouseUp);
            domElement.addEventListener('mouseleave', onMouseUp); 
            
            // YENÄ°: Fare TekerleÄŸi ile Zoom
            domElement.addEventListener('wheel', onStudioWheel);
        }

        function onStudioWheel(e) {
            e.preventDefault();
            
            const zoomSpeed = 0.05;
            // deltaY pozitif (aÅŸaÄŸÄ± kaydÄ±rma) = UzaklaÅŸma (zoom out)
            // deltaY negatif (yukarÄ± kaydÄ±rma) = YakÄ±nlaÅŸma (zoom in)
            
            const targetDistance = studioCamera.position.length();
            let newDistance = targetDistance + e.deltaY * zoomSpeed * targetDistance / 100;
            
            // SÄ±nÄ±rlama (Ã¶rneÄŸin 5 birim ile 200 birim arasÄ±)
            newDistance = Math.max(5, Math.min(200, newDistance));
            
            // Kamera pozisyonunu yeni mesafeye gÃ¶re ayarla (yÃ¶nÃ¼nÃ¼ koruyarak)
            studioCamera.position.normalize().multiplyScalar(newDistance);
        }
        
        // ... (onMouseDown, onMouseMove, onMouseUp fonksiyonlarÄ± aynen kalÄ±r) ...
        // ... (updateCamera, animateStudio, startStudioLoop, stopStudioLoop fonksiyonlarÄ± aynen kalÄ±r) ...

        // --- 5. OYUN CLIENT MANTIÄI (WASD + SPACE + TPS Kamera) ---
        
        function setupGame3D() {
            // ... (Kurulum)
            gameScene = new THREE.Scene();
            gameScene.background = new THREE.Color(0x87ceeb);

            gameCamera = new THREE.PerspectiveCamera(75, CANVAS_W / CANVAS_H, 0.1, 1000);
            
            gameScene.add(new THREE.AmbientLight(0x404040));
            gameScene.add(new THREE.DirectionalLight(0xffffff, 0.8));

            gameRenderer = new THREE.WebGLRenderer({ antialias: true });
            gameRenderer.setSize(CANVAS_W, CANVAS_H);

            const container = document.getElementById('gameCanvasContainer');
            while (container.firstChild) { container.removeChild(container.firstChild); }
            container.appendChild(gameRenderer.domElement);
            
            createBlocksFromData(gameScene, mapDataJSON, false);

            const playerGeo = new THREE.BoxGeometry(PLAYER_RADIUS * 2, PLAYER_HEIGHT, PLAYER_RADIUS * 2);
            const playerMat = new THREE.MeshLambertMaterial({ color: 0xff0000 });
            playerMesh = new THREE.Mesh(playerGeo, playerMat);
            playerMesh.position.set(0, PLAYER_HEIGHT / 2 + 1, 0); 
            gameScene.add(playerMesh);

            playerMesh.userData = {
                velX: 0, velY: 0, velZ: 0, onGround: false, rotationY: 0, rotationX: 0 // X rotasyonu eklendi
            };
            
            // Kamera Kontrolleri
            container.addEventListener('mousedown', onGameMouseDown);
            document.addEventListener('mousemove', onGameMouseMove);
            document.addEventListener('mouseup', onGameMouseUp);
            container.addEventListener('wheel', onGameWheel); // YENÄ°: Fare TekerleÄŸi

            // ... (Klavye ZÄ±plama aynen kalÄ±r) ...
        }

        function onGameMouseDown(e) {
            // SaÄŸ TÄ±k (2) ile sÃ¼rÃ¼klemeyi baÅŸlat
            if (e.button === 2) { 
                isGameDragging = true;
                gameDragStart.x = e.clientX;
                gameDragStart.y = e.clientY;
            }
        }

        function onGameMouseUp(e) {
            if (e.button === 2) { 
                isGameDragging = false;
            }
        }

        function onGameMouseMove(e) {
            if (!isGameDragging || !playerMesh) return;
            
            const deltaX = e.clientX - gameDragStart.x;
            const deltaY = e.clientY - gameDragStart.y; // YENÄ°: Dikey hareket de alÄ±nÄ±r
            
            // Player'Ä± Y ekseninde dÃ¶ndÃ¼r (SaÄŸa/Sola bakÄ±ÅŸ)
            playerMesh.rotation.y -= deltaX * GAME_ROTATE_SPEED;
            playerMesh.userData.rotationY = playerMesh.rotation.y;
            
            // Kamera aÃ§Ä±sÄ±nÄ± Y ekseninde dÃ¶ndÃ¼r (YukarÄ±/AÅŸaÄŸÄ± bakÄ±ÅŸ - Player'Ä± dÃ¶ndÃ¼rmez, sadece kamerayÄ±)
            playerMesh.userData.rotationX += deltaY * GAME_ROTATE_SPEED;
            
            // X rotasyonunu sÄ±nÄ±rla (Ã‡ok yukarÄ± veya Ã§ok aÅŸaÄŸÄ± bakmayÄ± engelle)
            playerMesh.userData.rotationX = Math.max(-Math.PI * 0.4, Math.min(Math.PI * 0.4, playerMesh.userData.rotationX));
            
            gameDragStart.x = e.clientX;
            gameDragStart.y = e.clientY;
        }

        function onGameWheel(e) {
            e.preventDefault();
            const zoomFactor = 0.05;
            
            // deltaY pozitif = UzaklaÅŸma (kamerayÄ± dÄ±ÅŸarÄ± it)
            currentZoomLevel += e.deltaY * zoomFactor; 
            
            currentZoomLevel = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoomLevel));
        }

        function updateGame() {
            if (!playerMesh) return;
            
            let userData = playerMesh.userData;
            let currentPos = playerMesh.position;
            
            let currentRotationY = userData.rotationY;
            
            // ... (Hareket VektÃ¶rleri ve Fizik aynen kalÄ±r) ...
            
            // --- HAREKET ---
            let forwardVector = new THREE.Vector3(0, 0, 1).applyAxisAngle(new THREE.Vector3(0, 1, 0), currentRotationY);
            let rightVector = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0, 1, 0), currentRotationY);
            
            if (keys['w']) currentPos.addScaledVector(forwardVector, MOVE_SPEED);
            if (keys['s']) currentPos.addScaledVector(forwardVector, -MOVE_SPEED);
            if (keys['a']) currentPos.addScaledVector(rightVector, -MOVE_SPEED);
            if (keys['d']) currentPos.addScaledVector(rightVector, MOVE_SPEED);

            // --- FÄ°ZÄ°K ---
            userData.velY -= GRAVITY;
            currentPos.y += userData.velY;
            userData.onGround = false;
            // ... (Ã‡arpÄ±ÅŸma KontrolÃ¼ aynen kalÄ±r) ...

            // --- 3. Kamera Takibi (TPS) ---
            
            // YENÄ°: Zoom seviyesini uygula
            const zoomDistance = TPS_DISTANCE_DEFAULT * currentZoomLevel;

            // Kamera rotasyonunu hesaplamak iÃ§in bir geÃ§ici obje kullan
            const tempCameraPivot = new THREE.Object3D();
            tempCameraPivot.rotation.y = currentRotationY;
            
            // X rotasyonunu (YukarÄ±/AÅŸaÄŸÄ± bakÄ±ÅŸ) pivot'a uygula
            tempCameraPivot.rotation.x = userData.rotationX; 

            // Pozisyon hesaplamasÄ±
            const offset = new THREE.Vector3(0, TPS_HEIGHT, zoomDistance);
            offset.applyEuler(tempCameraPivot.rotation);

            gameCamera.position.copy(playerMesh.position).sub(offset);
            
            // KameranÄ±n Player'a bakmasÄ±nÄ± saÄŸla
            gameCamera.lookAt(playerMesh.position.x, playerMesh.position.y + 2, playerMesh.position.z);
        }

        // ... (drawGame, gameLoop, startGameLoop, stopGameLoop aynen kalÄ±r) ... 


        // --- 6. AI MESAJLAÅMA MANTIÄI ---
        
        const AIS = {
            "PatatesSamocan": {
                name: "PatatesSamocan",
                avatar: "ğŸ¥”",
                response: (msg) => {
                    if (msg.toLowerCase().includes("merhaba")) return "Merhaba! ğŸ¥” Ben PatatesSamocan. Oyun yapÄ±mÄ±nda yardÄ±ma ihtiyacÄ±n var mÄ±?";
                    if (msg.toLowerCase().includes("mod")) return "ModlarÄ± N, B, O tuÅŸlarÄ±yla deÄŸiÅŸtirebilirsin. Hangi modu merak ediyorsun?";
                    if (msg.toLowerCase().includes("nasÄ±lsÄ±n")) return "Ã‡ok iyiyim, enerji doluyum! ğŸ”‹ Sen nasÄ±lsÄ±n?";
                    if (msg.toLowerCase().includes("kedi")) return "KediKIZ benim en iyi arkadaÅŸÄ±m ama bazen Ã§ok miyavlÄ±yor. ğŸ˜¼";
                    return "Beni ilgilendiren bir oyun nesnesi veya komutla gel, PatatesSamocan yardÄ±m etmeye hazÄ±r!";
                }
            },
            "KediKIZ": {
                name: "KediKIZ",
                avatar: "ğŸ±",
                response: (msg) => {
                    if (msg.toLowerCase().includes("merhaba")) return "Miyav! ğŸ± Beni seÃ§tiÄŸin iÃ§in teÅŸekkÃ¼rler. Ne tÃ¼r bir oyun yapÄ±yorsun? (Miyav!)";
                    if (msg.toLowerCase().includes("oyun")) return "Her oyunun temeli sÄ±kÄ± Ã§alÄ±ÅŸmadÄ±r, ama biraz da oyun oynamak gerekir! ğŸ¾";
                    if (msg.toLowerCase().includes("patates")) return "PatatesSamocan bazen Ã§ok ciddileÅŸiyor. Biraz tÃ¼y bÄ±rakmalÄ±. ğŸ˜¼";
                    if (msg.toLowerCase().includes("nasÄ±lsÄ±n")) return "TÃ¼ylerim kadar yumuÅŸak ve keyifliyim. ğŸ˜Š Sen nasÄ±lsÄ±n?";
                    return "Miyav! ğŸ¾ (AnlamadÄ±m ama harika gÃ¶rÃ¼ndÃ¼ÄŸÃ¼nÃ¼ biliyorum).";
                }
            }
        };

        function loadChatHistory(aiName) {
            const window = document.getElementById('chatWindow');
            window.innerHTML = '';
            
            if (chatHistory[aiName].length === 0) {
                 const firstMsg = AIS[aiName].response("merhaba");
                 chatHistory[aiName].push({ sender: aiName, text: firstMsg });
            }
            
            chatHistory[aiName].forEach(msg => {
                displayMessage(msg.sender, msg.text);
            });
            window.scrollTop = window.scrollHeight;
        }

        function displayMessage(sender, text) {
            const window = document.getElementById('chatWindow');
            const msgDiv = document.createElement('div');
            
            if (sender === currentUserName) {
                 msgDiv.className = 'message user-message';
                 msgDiv.textContent = text;
            } else {
                 msgDiv.className = 'message ai-message';
                 msgDiv.textContent = `${AIS[sender].avatar} ${text}`;
            }
            
            window.appendChild(msgDiv);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            const aiName = document.getElementById('aiSelector').value;

            if (message === "") return;

            // 1. KullanÄ±cÄ± mesajÄ±nÄ± gÃ¶ster
            displayMessage(currentUserName, message);
            chatHistory[aiName].push({ sender: currentUserName, text: message });

            input.value = '';
            document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;

            // 2. AI cevabÄ±nÄ± al ve gÃ¶ster
            setTimeout(() => {
                const aiResponse = AIS[aiName].response(message);
                displayMessage(aiName, aiResponse);
                chatHistory[aiName].push({ sender: aiName, text: aiResponse });
                document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
            }, 500); 
        }
        
        // --- UYGULAMA BAÅLANGICI ---
        window.onload = () => {
            // Oturum aÃ§ma ekranÄ±ndan baÅŸla
            showScreen('loginScreenContainer'); 
        };
    </script>
</body>
</html>
